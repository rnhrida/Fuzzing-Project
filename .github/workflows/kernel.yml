name: Kernel Fuzzer Pipeline
on:
  push:
    branches: [main]
jobs:
  fuzz-kernel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Tools
        run: sudo apt-get update -qq && sudo apt-get install -y clang libasan6
      - name: Build
        run: clang++ -fsanitize=fuzzer,address -g kernel/harness/kernel_harness.cc -o kernel_fuzzer
      - name: Fuzz
        run: mkdir -p kernel/output && timeout 300 ./kernel_fuzzer kernel/seeds/ -max_total_time=300 2>&1 | tee kernel/output/run.log || true
      - name: Upload
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: kernel-results
          path: kernel/output/
